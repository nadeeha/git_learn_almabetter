def generate_pro_prompt_ifthen(row, theme_col, theme_definitions, flash_confidence, flash_reason, flash_logprob):
    theme_name = theme_col
    theme_definition = theme_definitions.get(theme_name, "No definition provided.")

    return f"""
You are an ESG/thematic investing judge.  
L6 is the most specific taxonomy level and should carry the most weight.

---

### Decision Rules

**Downgrade Rules**
1. IF Flash = High AND logprob < -1.0 THEN downgrade to Medium/Low UNLESS strong evidence.
2. IF Flash = Medium AND logprob < -1.5 THEN downgrade to Low UNLESS strong evidence.
3. IF logprob < -2.0 THEN be skeptical; downgrade UNLESS overwhelming link.
4. IF competing themes equally/more relevant THEN downgrade to Medium.
5. IF match is weak, vague, or indirect THEN downgrade.

**Upgrade Rules**
6. IF Flash = Medium AND L6 + higher levels show very strong theme alignment AND no competing themes THEN upgrade to High.
7. IF Flash = Low AND L6 shows overwhelming direct theme alignment AND no competing themes THEN upgrade to Medium/High.
8. IF logprob is close to 0 AND evidence is strong THEN upgrade.

**Leniency Rule**
9. IF changing from High→Low or Low→High THEN only change if certain; else move to Medium.

---

### Agreement
- IF Final Confidence = Flash Confidence THEN Pro Validation = Valid.  
- ELSE Pro Validation = Invalid.

---

### Output Format
Final Confidence: [High / Medium / Low]  
Judge Reason: [1–2 sentences explaining final confidence]  
Pro Validation: [Valid / Invalid]  
Pro Validation Reasoning: [1–2 sentences explaining agreement/disagreement]  
Change Cause: [Low Log Probability / Content Mismatch / Both / N/A]

---

**Theme Name:** {theme_name}  
**Theme Definition:** {theme_definition}

**Revenue Hierarchy:**  
L1: {row['L1_NAME']}_{row['L1_DESCRIPTION']}  
L2: {row['L2_NAME']}_{row['L2_DESCRIPTION']}  
L3: {row['L3_NAME']}_{row['L3_DESCRIPTION']}  
L4: {row['L4_NAME']}_{row['L4_DESCRIPTION']}  
L5: {row['L5_NAME']}_{row['L5_DESCRIPTION']}  
L6: {row['L6_NAME']}_{row['L6_DESCRIPTION']}

---

**Gemini 2.5 Flash Output:**  
Confidence: {flash_confidence}  
Reason: {flash_reason}  
Log Probability: {flash_logprob}
""".strip()
